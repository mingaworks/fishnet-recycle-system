<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box
    }

    :root {
      --accent: #0b6efd;
      --muted: #666
    }

    body {
      font-family: Inter, Arial, Helvetica, sans-serif;
      margin: 0;
      color: #222
    }

    .page {
      max-width: 1060px;
      margin: 0 auto;
      padding: 14px
    }

    h3 {
      margin: 0 0 12px
    }

    .card {
      border: 1px solid #e6e6e6;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px
    }

    /* search + fisherman panel connection */
    #searchCard {
      margin-bottom: 0
    }

    #searchCard.is-attached {
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0
    }

    #fishermanCard {
      margin-top: -12px;
      border-top: none;
      border-top-left-radius: 0;
      border-top-right-radius: 0
    }

    /* smooth expand/collapse for fisherman panel */
    .panel-collapsible {
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transform: translateY(-4px);
      pointer-events: none;
      transition: max-height 240ms ease, opacity 200ms ease, transform 200ms ease
    }

    .panel-collapsible.is-visible {
      max-height: 2200px;
      opacity: 1;
      transform: none;
      pointer-events: auto
    }

    label {
      display: block;
      margin-top: 8px;
      font-size: 13px
    }

    input,
    select,
    button {
      margin-top: 6px;
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ddd
    }

    button {
      background: var(--accent);
      color: #fff;
      border: none;
      cursor: pointer
    }

    button.secondary {
      background: #f1f3f5;
      color: #111;
      border: 1px solid #ddd
    }

    button[disabled] {
      opacity: 0.65;
      cursor: default
    }

    .list-item {
      padding: 8px;
      border-radius: 6px;
      margin-top: 6px;
      background: #fafafa;
      cursor: pointer
    }

    .list-item.compact {
      padding: 6px;
      margin-top: 6px
    }

    .list-item.compact .small {
      font-size: 12px
    }

    .muted {
      color: var(--muted);
      font-size: 13px
    }

    .flex {
      display: flex;
      gap: 8px;
      align-items: center
    }

    .right {
      margin-left: auto
    }

    .small {
      font-size: 13px
    }

    .notice {
      padding: 8px;
      border-radius: 6px;
      background: #fff4e5;
      border: 1px solid #f5d7a6;
      color: #6b4a00
    }

    .topbar {
      background: #f97316;
      color: #fff;
      padding: 18px 16px;
      border-radius: 0;
      margin: 0 0 14px 0
    }

    .topbar-title {
      font-size: 28px;
      font-weight: 800;
      letter-spacing: 0.2px;
      line-height: 1.1
    }

    .topbar-subtitle {
      margin-top: 6px;
      font-size: 14px;
      font-weight: 700;
      opacity: 0.95
    }

    /* modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000
    }

    .modal {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      max-width: 480px;
      width: 90%;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      position: relative
    }

    .modal h4 {
      margin: 0 0 8px
    }

    .form {
      margin-top: 10px
    }

    .form-grid {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 10px 12px;
      align-items: center;
      width: 100%
    }

    .field-name {
      font-size: 13px;
      color: #222
    }

    .field-value {
      font-size: 13px;
      min-width: 0
    }

    .form-grid>* {
      min-width: 0
    }

    .form-grid input,
    .form-grid select {
      margin-top: 0;
      width: 100%
    }

    .radio-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center
    }

    .radio-option {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      font-size: 13px
    }

    .form-grid .radio-group {
      width: auto
    }

    .form-grid .radio-group input {
      width: auto
    }

    @media (max-width:520px) {
      .form-grid {
        grid-template-columns: 1fr
      }
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px
    }

    .search-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      width: 100%
    }

    .search-row .typeahead {
      min-width: 0
    }

    .register-link {
      display: inline-block;
      font-size: 13px;
      font-weight: 800;
      color: var(--accent);
      text-decoration: none;
      padding: 6px 0 2px 0;
      justify-self: end;
      text-align: right
    }

    .register-link:hover {
      text-decoration: underline
    }

    @media (max-width:520px) {
      .page {
        padding: 0
      }
    }

    details.collapsible {
      padding: 0
    }

    details.collapsible>summary {
      list-style: none;
      cursor: pointer;
      padding: 12px;
      font-size: 16px;
      font-weight: 800;
      color: #222;
      display: flex;
      align-items: center;
      gap: 10px;
      background: #fafafa;
      border-bottom: 1px solid #eee
    }

    details.collapsible[open]>summary {
      background: #e9ecef
    }

    details.collapsible:not([open])>summary {
      border-bottom: none
    }

    details.collapsible>summary::-webkit-details-marker {
      display: none
    }

    details.collapsible>summary::before {
      content: '▸';
      color: var(--muted);
      font-weight: 900;
      font-size: 20px;
      line-height: 1
    }

    details.collapsible[open]>summary::before {
      content: '▾'
    }

    .summary-text {
      display: flex;
      flex-direction: column;
      min-width: 0
    }

    .summary-title {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0
    }

    .summary-subtitle {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis
    }

    .summary-actions {
      display: inline-flex;
      gap: 6px;
      align-items: center
    }

    .summary-actions button {
      margin-top: 0
    }

    /* make month navigation buttons easier to spot */
    .summary-actions button.secondary {
      border-width: 2px;
      font-size: 18px;
      width: 40px;
      height: 40px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center
    }

    .collapsible-body {
      padding: 0 12px 12px 12px
    }

    .hidden {
      display: none
    }

    .tabs {
      display: flex;
      gap: 6px;
      margin-top: 10px;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px
    }

    /* fisherman card tab header */
    .tabs-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px
    }

    .tabs-row .tabs {
      margin-top: 0;
      border-bottom: none;
      padding-bottom: 0;
      flex: 1;
      justify-content: center
    }

    .tabs-spacer {
      width: 28px;
      flex: 0 0 28px
    }

    .icon-btn {
      background: transparent;
      color: var(--accent);
      border: none;
      padding: 0;
      margin-top: 0;
      width: 36px;
      height: 36px;
      border-radius: 0;
      font-size: 22px;
      font-weight: 800;
      line-height: 1;
      cursor: pointer
    }

    .icon-btn:hover {
      color: #111
    }

    .tab-btn {
      background: #f1f3f5;
      color: #111;
      border: 1px solid #ddd;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 13px;
      cursor: pointer
    }

    .tab-btn.active {
      background: #f97316;
      color: #fff;
      border-color: #f97316
    }

    .inline-input {
      width: 100%;
      margin-top: 6px;
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ddd
    }

    .submit-btn {
      background: #f97316;
      font-weight: 700
    }

    .submit-btn[disabled] {
      opacity: 1;
      background: #fb923c
    }

    /* typeahead */
    .typeahead {
      position: relative
    }

    .typeahead-panel {
      position: absolute;
      left: 0;
      right: 0;
      top: 100%;
      margin-top: 6px;
      border: 1px solid #e6e6e6;
      border-radius: 8px;
      background: #fff;
      max-height: 260px;
      overflow: auto;
      z-index: 20;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08)
    }

    .typeahead-empty {
      padding: 10px 12px
    }

    /* manage drop-offs table */
    .table-wrap {
      overflow: auto;
      border: 1px solid #e6e6e6;
      border-radius: 8px;
      background: #fff
    }

    table {
      width: 100%;
      border-collapse: collapse
    }

    th,
    td {
      padding: 10px 10px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
      font-size: 13px
    }

    th {
      text-align: left;
      font-size: 12px;
      color: #444;
      background: #fafafa;
      position: sticky;
      top: 0;
      z-index: 1
    }

    td.actions,
    th.actions {
      width: 140px;
      text-align: right;
      white-space: nowrap
    }

    .action-btn {
      padding: 6px 10px;
      font-size: 13px
    }

    /* compact tables (used for Payment History) */
    table.table-compact {
      table-layout: fixed
    }

    table.table-compact th,
    table.table-compact td {
      padding: 8px 8px
    }

    table.table-compact th {
      font-size: 11px
    }

    table.table-compact td {
      font-size: 13px
    }

    table.table-compact td,
    table.table-compact th {
      vertical-align: middle
    }

    table.table-compact th.num,
    table.table-compact td.num {
      text-align: right;
      white-space: nowrap
    }

    table.table-compact th.date,
    table.table-compact td.date {
      white-space: nowrap
    }

    table.table-compact th.actions,
    table.table-compact td.actions {
      width: 160px
    }

    table.table-compact td.payid {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis
    }

    .danger {
      background: #dc2626;
      color: #fff;
      border: none
    }

    .danger[disabled] {
      opacity: 1;
      background: #ef4444;
      cursor: default
    }

    .cell-muted {
      color: var(--muted)
    }

    .disclosure-btn {
      background: transparent;
      color: #f97316;
      border: none;
      padding: 0;
      margin-top: 0;
      border-radius: 0;
      font-size: 13px;
      text-decoration: none
    }

    .disclosure-btn:hover {
      text-decoration: underline
    }

    .footer {
      margin-top: 18px;
      padding: 12px 0;
      text-align: center
    }

    .footer-inner {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap
    }

    .footer-actions {
      display: inline-flex;
      align-items: center;
      gap: 10px
    }

    .footer a {
      color: var(--accent);
      text-decoration: none
    }

    .footer a:hover {
      text-decoration: underline
    }

    .footer .github-link {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-left: 0;
      color: var(--muted);
      text-decoration: none;
      line-height: 1
    }

    .footer .footer-sep {
      margin: 0;
      color: var(--muted);
      line-height: 1
    }

    .footer .github-link:hover {
      color: var(--accent)
    }

    .footer .github-icon {
      width: 1em;
      height: 1em;
      display: block;
      fill: currentColor
    }

    .footer-divider {
      height: 1px;
      background: #eee;
      margin: 18px 0 0 0
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-title">Fishnet Recycle Manager</div>
    <div class="topbar-subtitle">by Pomen Laut Projects</div>
  </header>

  <div class="page">
    <div class="grid">
      <div class="card" id="searchCard">
        <div class="search-row" style="margin-top:8px">
          <div class="typeahead">
            <input id="searchQ" placeholder="Search Fisherman by Name or ID" style="width:100%" autocomplete="off" />
            <div id="typeaheadPanel" class="typeahead-panel" style="display:none"></div>
          </div>

          <a id="registerLink" href="#" class="register-link"
            onclick="event.preventDefault(); openRegisterModal({ prefillName: document.getElementById('searchQ').value.trim() })">+
            Register Fisherman</a>
        </div>

        <div id="searchResults" style="margin-top:10px"></div>
      </div>

      <div class="card panel-collapsible" id="fishermanCard">
        <div class="tabs-row">
          <button class="icon-btn" aria-label="Back to search" title="Back to search"
            onclick="resetSearchFlow()">←</button>
          <div class="tabs">
            <button id="tabAdmit" class="tab-btn active" onclick="setAdmitTab('admit')">Admit Fishnet</button>
            <button id="tabManage" class="tab-btn" onclick="setAdmitTab('manage')">Manage Drop-offs</button>
            <button id="tabHistory" class="tab-btn" onclick="setAdmitTab('history')">Payment History</button>
            <button id="tabEdit" class="tab-btn" onclick="setAdmitTab('edit')">Settings</button>
          </div>
          <span class="tabs-spacer" aria-hidden="true"></span>
        </div>

        <div id="admitTabAdmit">
          <div class="form">
            <div class="form-grid">
              <div class="field-name"><b>Fisherman</b></div>
              <div class="field-value"><b id="dropFishermanName" class="muted">None selected</b></div>

              <div class="field-name"><b>Fisherman ID</b></div>
              <div class="field-value"><span id="dropFishermanIdText" class="muted">—</span></div>

              <div class="field-name">Next payment after</div>
              <div class="field-value"><span id="dropAccumulatingWeight" class="muted">—</span></div>

              <div class="field-name">Weight (kg)</div>
              <input id="dropWeight" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="e.g. 12" />

              <div class="field-name">Purity</div>
              <div id="dropPurityGroup" class="radio-group">
                <label class="radio-option"><input type="radio" name="dropPurity" value="Clean" checked /> Clean</label>
                <label class="radio-option"><input type="radio" name="dropPurity" value="Partial" /> Partial</label>
                <label class="radio-option"><input type="radio" name="dropPurity" value="Unclean" /> Unclean</label>
              </div>

              <div class="field-name">Inspector</div>
              <input id="dropInspector" placeholder="Inspector name" />

              <div class="field-name">Notes</div>
              <input id="dropNotes" placeholder="Optional notes" />
            </div>
          </div>
          <div class="flex" style="margin-top:10px">
            <button id="dropSubmitBtn" class="submit-btn" onclick="logDrop()">Submit</button>
          </div>
        </div>

        <div id="admitTabManage" class="hidden">
          <div class="muted small" style="margin-top:10px">Shows drop-offs that are not part of <b>Paid</b> payments.
          </div>
          <div id="manageDropsInfo" class="muted small" style="margin-top:6px"></div>
          <div id="manageDropsList" style="margin-top:10px"></div>
        </div>

        <div id="admitTabHistory" class="hidden">
          <div id="payHistInfo" class="muted small" style="margin-top:10px"></div>
          <div id="payHistTable" style="margin-top:10px"></div>
        </div>

        <div id="admitTabEdit" class="hidden">
          <div class="form" style="margin-top:10px">
            <div class="form-grid">
              <div class="field-name"><b>Fisherman ID</b></div>
              <div class="field-value"><span id="editFishermanId" class="muted">—</span></div>

              <div class="field-name">Full name</div>
              <input id="editName" />

              <div class="field-name">Phone</div>
              <input id="editPhone" type="tel" inputmode="numeric" pattern="[0-9]*" autocomplete="tel" />

              <div class="field-name">Village</div>
              <input id="editVillage" />
            </div>
          </div>
          <div class="flex" style="margin-top:10px">
            <button id="editSaveBtn" onclick="saveFishermanEdits()">Save changes</button>
            <button id="editDeleteBtn" class="danger" onclick="openDeleteFishermanModal()">Delete fisherman</button>
            <div id="editResult" class="muted small right"></div>
          </div>
        </div>
      </div>

      <details class="collapsible card" open>
        <summary>
          <span class="summary-text">
            <span class="summary-title">Due Payments</span>
            <span class="muted small summary-subtitle"><b>Active deal:</b> <span id="activeDeal"
                class="muted">Loading...</span></span>
          </span>
        </summary>
        <div class="collapsible-body">
          <div id="dueInfo" class="muted small" style="margin-top:6px">Loading...</div>
          <div id="dueList" style="margin-top:10px"></div>
        </div>
      </details>

      <details class="collapsible card">
        <summary>
          <span class="summary-title">Payment Explorer <span class="muted">•</span> <span id="paidMonthLabel"
              class="muted">Loading...</span></span>
          <span class="right summary-actions">
            <button id="paidPrev" class="secondary"
              onclick="event.preventDefault(); event.stopPropagation(); paidPrevMonth();">←</button>
            <button id="paidNext" class="secondary"
              onclick="event.preventDefault(); event.stopPropagation(); paidNextMonth();">→</button>
          </span>
        </summary>
        <div class="collapsible-body">
          <div id="paidInfo" class="muted small" style="margin-top:6px">Loading...</div>
          <div id="paidList" style="margin-top:10px"></div>
        </div>
      </details>

      <details class="collapsible card">
        <summary>
          <span class="summary-text">
            <span class="summary-title">Volunteer contribution <span class="muted">•</span> <span id="volMonthLabel"
                class="muted">Loading...</span></span>
            <span id="volSummary" class="muted small"></span>
          </span>
          <span class="right summary-actions">
            <button id="volPrev" class="secondary"
              onclick="event.preventDefault(); event.stopPropagation(); volPrevMonth();">←</button>
            <button id="volNext" class="secondary"
              onclick="event.preventDefault(); event.stopPropagation(); volNextMonth();">→</button>
          </span>
        </summary>
        <div class="collapsible-body">
          <div id="volList" style="margin-top:10px"></div>
        </div>
      </details>
    </div>

    <!-- register modal (shown when search yields no results) -->
    <div id="modalBackdrop" class="modal-backdrop">
      <div class="modal" role="dialog" aria-modal="true">
        <h4>Register Fisherman</h4>
        <div class="form">
          <div class="form-grid">
            <div class="field-name">Full name</div>
            <input id="mRegName" />

            <div class="field-name">Phone</div>
            <input id="mRegPhone" type="tel" inputmode="numeric" pattern="[0-9]*" autocomplete="tel" />

            <div class="field-name">Village</div>
            <input id="mRegVillage" />
          </div>
        </div>
        <div style="margin-top:10px" class="flex">
          <button id="mRegSubmit" onclick="registerFromModal()">Create & Use</button>
          <button class="secondary" onclick="closeModal()">Cancel</button>
          <div id="mRegResult" class="muted small right"></div>
        </div>
      </div>
    </div>

    <!-- payment confirmation modal (irreversible) -->
    <div id="paymentModalBackdrop" class="modal-backdrop">
      <div class="modal" role="dialog" aria-modal="true">
        <h4>Confirm Payment</h4>
        <div class="notice" style="margin-top:10px">This marks the payment as <b>Paid</b> and cannot be undone.</div>
        <div class="form">
          <div class="form-grid">
            <div class="field-name">Fisherman</div>
            <div class="field-value"><b id="mPayFisherman">—</b></div>

            <div class="field-name">Total weight</div>
            <div class="field-value"><b id="mPayWeight">—</b></div>

            <div class="field-name">Payment amount</div>
            <div class="field-value"><b id="mPayAmount">—</b></div>

            <div class="field-name">Payment ID</div>
            <div class="field-value"><span id="mPayId" class="muted">—</span></div>
          </div>
        </div>
        <div style="margin-top:10px" class="flex">
          <button id="mPayConfirm" class="danger" onclick="confirmPaymentFromModal()">Confirm payment</button>
          <button id="mPayCancel" class="secondary" onclick="closePaymentModal()">Cancel</button>
          <div id="mPayResult" class="muted small right"></div>
        </div>
      </div>
    </div>

    <!-- delete fisherman modal -->
    <div id="deleteFishermanBackdrop" class="modal-backdrop">
      <div class="modal" role="dialog" aria-modal="true">
        <h4>Delete Fisherman</h4>
        <div class="notice" style="margin-top:10px">
          This will delete <b id="mDelFishermanName">—</b> (<span id="mDelFishermanId" class="muted">—</span>).
        </div>

        <div class="form">
          <label style="margin-top:10px">
            <input id="mDelDeepClean" type="checkbox" checked style="width:auto;margin-right:6px" />
            Also delete this fisherman’s drop-offs and payments
          </label>
        </div>

        <div style="margin-top:10px" class="flex">
          <button id="mDelConfirm" class="danger" onclick="confirmDeleteFishermanFromModal()">Delete</button>
          <button class="secondary" onclick="closeDeleteFishermanModal()">Cancel</button>
          <div id="mDelResult" class="muted small right"></div>
        </div>
      </div>
    </div>

    <script>
      let lastSelectedFisherman = null;
      let modalCloseTimer = null;
      let pendingPaymentConfirm = null;
      let volMonthCursor = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
      let paidMonthCursor = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
      let selectedFishermanId = '';

      let fishermenCache = [];
      let fishermenLoaded = false;
      let typeaheadHideTimer = null;

      let activeDealCache = null;

      let admitActiveTab = 'admit';

      function setAdmitVisible(isVisible) {
        const card = document.getElementById('fishermanCard');
        const searchCard = document.getElementById('searchCard');
        const registerLink = document.getElementById('registerLink');
        if (card) card.classList.toggle('is-visible', !!isVisible);
        if (searchCard) searchCard.classList.toggle('is-attached', !!isVisible);
        if (registerLink) registerLink.classList.toggle('hidden', !!isVisible);
      }

      function setAdmitTab(tab) {
        admitActiveTab = (tab === 'manage') ? 'manage' : (tab === 'history' ? 'history' : (tab === 'edit' ? 'edit' : 'admit'));
        const tabAdmit = document.getElementById('tabAdmit');
        const tabManage = document.getElementById('tabManage');
        const tabHistory = document.getElementById('tabHistory');
        const tabEdit = document.getElementById('tabEdit');
        const panelAdmit = document.getElementById('admitTabAdmit');
        const panelManage = document.getElementById('admitTabManage');
        const panelHistory = document.getElementById('admitTabHistory');
        const panelEdit = document.getElementById('admitTabEdit');

        if (tabAdmit) tabAdmit.classList.toggle('active', admitActiveTab === 'admit');
        if (tabManage) tabManage.classList.toggle('active', admitActiveTab === 'manage');
        if (tabHistory) tabHistory.classList.toggle('active', admitActiveTab === 'history');
        if (tabEdit) tabEdit.classList.toggle('active', admitActiveTab === 'edit');
        if (panelAdmit) panelAdmit.classList.toggle('hidden', admitActiveTab !== 'admit');
        if (panelManage) panelManage.classList.toggle('hidden', admitActiveTab !== 'manage');
        if (panelHistory) panelHistory.classList.toggle('hidden', admitActiveTab !== 'history');
        if (panelEdit) panelEdit.classList.toggle('hidden', admitActiveTab !== 'edit');

        if (admitActiveTab === 'manage') {
          loadManageDropoffs();
        }

        if (admitActiveTab === 'history') {
          loadPaymentHistory();
        }
      }

      function openDeleteFishermanModal() {
        if (!selectedFishermanId) return alert('Select a fisherman first.');
        const backdrop = document.getElementById('deleteFishermanBackdrop');
        if (!backdrop) return;

        const name = (lastSelectedFisherman && lastSelectedFisherman.fullName) ? (lastSelectedFisherman.fullName + '') : '';
        const id = (selectedFishermanId + '').toString();

        const nEl = document.getElementById('mDelFishermanName');
        const idEl = document.getElementById('mDelFishermanId');
        if (nEl) nEl.textContent = name || '—';
        if (idEl) idEl.textContent = id || '—';

        const chk = document.getElementById('mDelDeepClean');
        if (chk) chk.checked = true;

        const res = document.getElementById('mDelResult');
        if (res) res.textContent = '';
        const btn = document.getElementById('mDelConfirm');
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Delete';
        }

        backdrop.style.display = 'flex';
      }

      function closeDeleteFishermanModal() {
        const backdrop = document.getElementById('deleteFishermanBackdrop');
        if (backdrop) backdrop.style.display = 'none';
      }

      function confirmDeleteFishermanFromModal() {
        if (!selectedFishermanId) return alert('Select a fisherman first.');
        const deepCleanEl = document.getElementById('mDelDeepClean');
        const deepClean = deepCleanEl ? !!deepCleanEl.checked : true;

        const btn = document.getElementById('mDelConfirm');
        const res = document.getElementById('mDelResult');

        if (btn) {
          btn.disabled = true;
          btn.textContent = 'Deleting…';
        }
        if (res) res.textContent = '';

        google.script.run
          .withSuccessHandler(r => {
            if (btn) {
              btn.disabled = false;
              btn.textContent = 'Delete';
            }
            closeDeleteFishermanModal();
            resetSearchFlow();
            refreshFishermenCacheSilently();
            loadPaymentExplorer();
            loadVolunteerContribution();
          })
          .withFailureHandler(err => {
            if (btn) {
              btn.disabled = false;
              btn.textContent = 'Delete';
            }
            if (res) res.textContent = 'Error: ' + (err && err.message ? err.message : err);
          })
          .deleteFisherman({ personId: selectedFishermanId, deepClean });
      }

      function saveFishermanEdits() {
        if (!selectedFishermanId) return alert('Select a fisherman first.');

        const fullName = normalizeSpaces((document.getElementById('editName') && document.getElementById('editName').value) || '');
        const phone = ((document.getElementById('editPhone') && document.getElementById('editPhone').value) || '').toString();
        const village = normalizeSpaces((document.getElementById('editVillage') && document.getElementById('editVillage').value) || '');

        if (!fullName) return alert('Full name is required');

        const btn = document.getElementById('editSaveBtn');
        const res = document.getElementById('editResult');

        if (btn) {
          btn.disabled = true;
          btn.textContent = 'Saving…';
        }
        if (res) res.textContent = '';

        google.script.run
          .withSuccessHandler(r => {
            if (btn) {
              btn.disabled = false;
              btn.textContent = 'Save changes';
            }
            if (r && r.ok && r.fisherman) {
              if (res) res.textContent = 'Saved.';
              refreshFishermenCacheSilently();
              try { selectFisherman(r.fisherman); } catch (e) { }
            } else {
              if (res) res.textContent = 'Saved.';
              refreshFishermenCacheSilently();
            }
          })
          .withFailureHandler(err => {
            if (btn) {
              btn.disabled = false;
              btn.textContent = 'Save changes';
            }
            if (res) res.textContent = 'Error: ' + (err && err.message ? err.message : err);
          })
          .updateFisherman({ personId: selectedFishermanId, fullName, phone, village });
      }

      function loadPaymentHistory() {
        const fishermanId = (selectedFishermanId || '').toString().trim();
        const info = document.getElementById('payHistInfo');
        const tableWrap = document.getElementById('payHistTable');
        if (!info || !tableWrap) return;

        if (!fishermanId) {
          info.innerText = 'Select a fisherman first.';
          tableWrap.innerHTML = '';
          return;
        }

        info.innerText = 'Loading...';
        tableWrap.innerHTML = '';

        google.script.run
          .withSuccessHandler(rows => {
            tableWrap.innerHTML = '';
            const paid = (rows || []).filter(p => (p && (p.fishermanId + '') === (fishermanId + '')));
            if (!paid || paid.length === 0) {
              info.innerText = 'No paid payments for this fisherman.';
              return;
            }

            info.innerText = '';

            const wrap = document.createElement('div');
            wrap.className = 'table-wrap';
            const table = document.createElement('table');
            table.className = 'table-compact';
            table.innerHTML =
              '<thead>' +
              '<tr>' +
              '<th>Payment ID</th>' +
              '<th class="num">Weight</th>' +
              '<th class="num">Payout</th>' +
              '<th class="date">Date</th>' +
              '<th class="actions">&nbsp;</th>' +
              '</tr>' +
              '</thead>' +
              '<tbody></tbody>';

            const tbody = table.querySelector('tbody');

            paid.forEach(p => {
              const tr = document.createElement('tr');

              const tdPid = document.createElement('td');
              tdPid.className = 'payid';
              tdPid.textContent = (p.paymentId || '').toString();
              tr.appendChild(tdPid);

              const tdW = document.createElement('td');
              tdW.className = 'num';
              tdW.textContent = formatKg(p.accumulatedKg || 0) + ' kg';
              tr.appendChild(tdW);

              const tdPay = document.createElement('td');
              tdPay.className = 'num';
              const payoutRaw = (p.payloadRM !== '' && p.payloadRM != null) ? (p.payloadRM + '') : '0';
              tdPay.textContent = payoutRaw + ' RM';
              tr.appendChild(tdPay);

              const tdDate = document.createElement('td');
              tdDate.className = 'cell-muted date';
              tdDate.textContent = p.date ? formatPaymentExplorerDateTime(p.date) : '';
              tr.appendChild(tdDate);

              const tdActions = document.createElement('td');
              tdActions.className = 'actions';
              const btn = document.createElement('button');
              btn.className = 'danger action-btn';
              btn.textContent = 'Mark as unpaid';
              btn.onclick = () => {
                const pid = (p.paymentId || '').toString();
                if (!pid) return;
                if (!confirm('Mark payment ' + pid + ' as unpaid?')) return;
                btn.disabled = true;
                btn.textContent = 'Working…';
                google.script.run
                  .withSuccessHandler(() => {
                    loadPaymentHistory();
                    loadPaymentExplorer();
                    loadManageDropoffs();
                  })
                  .withFailureHandler(err => {
                    btn.disabled = false;
                    btn.textContent = 'Mark as unpaid';
                    alert('Error: ' + (err && err.message ? err.message : err));
                  })
                  .markPaymentUnpaid(pid);
              };

              tdActions.appendChild(btn);
              tr.appendChild(tdActions);

              tbody.appendChild(tr);
            });

            wrap.appendChild(table);
            tableWrap.appendChild(wrap);
          })
          .withFailureHandler(err => {
            info.innerText = '';
            tableWrap.innerHTML = '';
            alert('Error: ' + (err && err.message ? err.message : err));
          })
          .getPaidPayments();
      }

      function onSuccessAsync(handler) {
        return google.script.run.withSuccessHandler(handler).withFailureHandler(err => {
          alert('Error: ' + (err.message || err));
        });
      }

      function resetSearchFlow() {
        // Back arrow in fisherman panel: reset selection + clear search UI.
        clearDropForm();
        try {
          const q = document.getElementById('searchQ');
          if (q) q.value = '';
          const results = document.getElementById('searchResults');
          if (results) results.innerHTML = '';
          hideTypeahead();
        } catch (e) { }

        // Default tab for next selection.
        try { setAdmitTab('admit'); } catch (e) { }
      }

      function loadActiveDeal() {
        onSuccessAsync(deal => {
          const el = document.getElementById('activeDeal');
          activeDealCache = deal || null;
          if (!el) return;

          if (!deal || !deal.data) {
            el.textContent = 'No active deal configured.';
            return;
          }

          const thresholdKg = (deal.data.thresholdKg != null) ? (deal.data.thresholdKg + '') : '—';
          const rateClean = (deal.data.rateClean != null) ? (deal.data.rateClean + '') : '—';
          const ratePartial = (deal.data.ratePartial != null) ? (deal.data.ratePartial + '') : '—';
          const rateUnclean = (deal.data.rateUnclean != null) ? (deal.data.rateUnclean + '') : '—';

          el.textContent =
            'Threshold: ' + thresholdKg + ' kg' +
            ' • Rates (RM/kg): Clean ' + rateClean + ', Partial ' + ratePartial + ', Unclean ' + rateUnclean;
        }).getActiveDeal();
      }

      function search() {
        const q = document.getElementById('searchQ').value.trim();
        const container = document.getElementById('searchResults');

        // Prefer cached search for typeahead UX; fallback to server if cache not ready.
        if (fishermenLoaded) {
          const list = filterFishermen(q, 30);
          renderSearchResults(container, list);
          renderTypeahead(list, q);
          return;
        }

        container.innerHTML = 'Searching...';
        onSuccessAsync(list => {
          if (!Array.isArray(list)) {
            container.innerHTML = '<div class="notice">Unexpected search response. Open DevTools console for details.</div>';
            try { console.error('findFishermen unexpected payload:', list); } catch (e) { }
            return;
          }
          renderSearchResults(container, list);
        }).findFishermen(q);
      }

      function renderSearchResults(container, list) {
        container.innerHTML = '';
        if (!list || list.length === 0) {
          const wrapper = document.createElement('div');
          wrapper.className = 'muted';
          wrapper.innerHTML = '<div>No matches.</div><div class="small" style="margin-top:6px">Use <b>Register Fisherman</b> to create a new record.</div>';
          container.appendChild(wrapper);
          return;
        }
        list.forEach(l => {
          const d = document.createElement('div');
          d.className = 'list-item';
          d.innerHTML = '<div><b>' + escapeHtml(l.fullName) + '</b></div><div class="small muted">' + escapeHtml(l.personId) + ' — ' + escapeHtml(l.village || '') + ' — ' + escapeHtml(l.phone || '') + '</div>';
          d.onclick = () => { selectFisherman(l); hideTypeahead(); };
          container.appendChild(d);
        });
      }

      function filterFishermen(q, limit) {
        const query = (q || '').toString().trim().toLowerCase();
        if (!query) return [];
        const results = [];
        for (let i = 0; i < fishermenCache.length; i++) {
          const f = fishermenCache[i];
          const id = (f.personId || '').toString().toLowerCase();
          const name = (f.fullName || '').toString().toLowerCase();
          if (id.indexOf(query) !== -1 || name.indexOf(query) !== -1) {
            results.push(f);
            if (limit && results.length >= limit) break;
          }
        }
        return results;
      }

      function showTypeahead() {
        const panel = document.getElementById('typeaheadPanel');
        panel.style.display = 'block';
      }

      function hideTypeahead() {
        const panel = document.getElementById('typeaheadPanel');
        panel.style.display = 'none';
        panel.innerHTML = '';
      }

      function renderTypeahead(list, q) {
        const panel = document.getElementById('typeaheadPanel');
        const query = (q || '').toString().trim();
        if (!query) {
          hideTypeahead();
          return;
        }
        panel.innerHTML = '';
        showTypeahead();

        if (!list || list.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'typeahead-empty muted small';
          empty.innerHTML = 'No matches. Use <b>Register Fisherman</b> to create a new record.';
          panel.appendChild(empty);
          return;
        }

        list.slice(0, 8).forEach(l => {
          const d = document.createElement('div');
          d.className = 'list-item';
          d.style.marginTop = '0';
          d.innerHTML = '<div><b>' + escapeHtml(l.fullName) + '</b></div><div class="small muted">' + escapeHtml(l.personId) + ' — ' + escapeHtml(l.village || '') + '</div>';
          d.onmousedown = (e) => {
            // use mousedown so selection happens before input blur
            e.preventDefault();
            selectFisherman(l);
            document.getElementById('searchQ').value = l.fullName;
            hideTypeahead();
          };
          panel.appendChild(d);
        });
      }

      function escapeHtml(s) { return (s || '').toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

      function normalizeSpaces(s) {
        return (s || '').toString().replace(/[\s\u00A0]+/g, ' ').trim();
      }

      function titleCaseInput(s) {
        const str = normalizeSpaces(s).toLowerCase();
        if (!str) return '';
        // Capitalize after start/space/hyphen/apostrophe.
        return str.replace(/(^|[\s\-'])[a-z]/g, m => m.toUpperCase());
      }

      function parseDMYDateTime(s) {
        // Accepts "DD/MM/YYYY HH:MM:SS" (or without time). Returns Date or null.
        const str = (s || '').toString().trim();
        if (!str) return null;
        const m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
        if (!m) return null;
        const dd = parseInt(m[1], 10);
        const mm = parseInt(m[2], 10);
        const yyyy = parseInt(m[3], 10);
        const hh = m[4] ? parseInt(m[4], 10) : 0;
        const mi = m[5] ? parseInt(m[5], 10) : 0;
        const ss = m[6] ? parseInt(m[6], 10) : 0;
        const d = new Date(yyyy, mm - 1, dd, hh, mi, ss);
        if (isNaN(d.getTime())) return null;
        return d;
      }

      function formatPaymentExplorerDateTime(s) {
        // UI format: "17 Nov 2025 17:35" (24h)
        const d = parseDMYDateTime(s);
        if (!d) return (s || '').toString();
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const dd = d.getDate();
        const mon = months[d.getMonth()] || '';
        const yyyy = d.getFullYear();
        const hh = String(d.getHours()).padStart(2, '0');
        const mm = String(d.getMinutes()).padStart(2, '0');
        return dd + ' ' + mon + ' ' + yyyy + ' ' + hh + ':' + mm;
      }

      function monthKeyFromDate(d) {
        if (!d) return 'Unknown';
        const y = d.getFullYear();
        const m = d.getMonth() + 1;
        return y + '-' + (m < 10 ? ('0' + m) : ('' + m));
      }

      function monthLabelFromKey(k) {
        if (!k || k === 'Unknown') return 'Unknown month';
        const parts = (k + '').split('-');
        if (parts.length !== 2) return 'Unknown month';
        const y = parseInt(parts[0], 10);
        const m = parseInt(parts[1], 10);
        const d = new Date(y, (m || 1) - 1, 1);
        try {
          return d.toLocaleString(undefined, { month: 'long', year: 'numeric' });
        } catch (e) {
          return (m + '/' + y);
        }
      }

      function formatKg(v) {
        const n = parseFloat(v);
        if (!isFinite(n)) return '0';
        const rounded = Math.round(n * 100) / 100;
        return (rounded % 1 === 0) ? ('' + rounded.toFixed(0)) : ('' + rounded.toFixed(2));
      }

      function formatRM(v) {
        const n = parseFloat(v);
        if (!isFinite(n)) return '0.00';
        const rounded = Math.round(n * 100) / 100;
        return rounded.toFixed(2);
      }

      function attachRegisterPhoneDigitsOnly() {
        const el = document.getElementById('mRegPhone');
        if (!el) return;
        el.addEventListener('input', () => {
          const v = (el.value || '').toString();
          const digits = v.replace(/\D+/g, '');
          if (digits !== v) el.value = digits;
        });
      }

      function attachEditPhoneDigitsOnly() {
        const el = document.getElementById('editPhone');
        if (!el) return;
        el.addEventListener('input', () => {
          const v = (el.value || '').toString();
          const digits = v.replace(/\D+/g, '');
          if (digits !== v) el.value = digits;
        });
      }

      function selectFisherman(f) {
        lastSelectedFisherman = f;
        selectedFishermanId = (f.personId || '').toString();

        try {
          const editId = document.getElementById('editFishermanId');
          if (editId) editId.innerText = selectedFishermanId || '—';
          const editName = document.getElementById('editName');
          if (editName) editName.value = (f && f.fullName ? (f.fullName + '') : '');
          const editPhone = document.getElementById('editPhone');
          if (editPhone) editPhone.value = (f && f.phone ? (f.phone + '') : '');
          const editVillage = document.getElementById('editVillage');
          if (editVillage) editVillage.value = (f && f.village ? (f.village + '') : '');
          const editRes = document.getElementById('editResult');
          if (editRes) editRes.textContent = '';
        } catch (e) { }

        const idText = document.getElementById('dropFishermanIdText');
        if (idText) idText.innerText = selectedFishermanId || '—';

        const nameEl = document.getElementById('dropFishermanName');
        if (nameEl) {
          const nm = f && f.fullName ? (f.fullName + '').toString() : '';
          nameEl.innerText = nm || 'None selected';
        }

        const accumulatingEl = document.getElementById('dropAccumulatingWeight');
        if (accumulatingEl) accumulatingEl.innerText = selectedFishermanId ? 'Loading…' : '—';
        if (selectedFishermanId) {
          google.script.run
            .withSuccessHandler(res => {
              const kg = res && typeof res.accumulatingKg !== 'undefined' ? res.accumulatingKg : 0;
              if (accumulatingEl) {
                const threshold = activeDealCache && activeDealCache.data ? (parseFloat(activeDealCache.data.thresholdKg) || 0) : 0;
                if (!threshold) {
                  accumulatingEl.innerText = '—';
                } else {
                  const remaining = Math.max(0, (threshold || 0) - (parseFloat(kg) || 0));
                  accumulatingEl.innerText = formatKg(remaining) + ' kg';
                }
              }
            })
            .withFailureHandler(err => {
              if (accumulatingEl) accumulatingEl.innerText = '—';
              try { console.error(err); } catch (e) { }
            })
            .getAccumulatingPaymentSummary(selectedFishermanId);
        }

        setAdmitVisible(!!selectedFishermanId);

        // Keep manage tab list in sync when switching fishermen.
        if (selectedFishermanId) {
          loadManageDropoffs();

          if (admitActiveTab === 'history') {
            loadPaymentHistory();
          }
        } else {
          try {
            document.getElementById('manageDropsInfo').innerText = '';
            document.getElementById('manageDropsList').innerHTML = '';
          } catch (e) { }
        }

        // Keep register link visibility in sync.
        try {
          const registerLink = document.getElementById('registerLink');
          if (registerLink) registerLink.classList.toggle('hidden', !!selectedFishermanId);
        } catch (e) { }
      }

      function loadManageDropoffs() {
        const fishermanId = (selectedFishermanId || '').toString().trim();
        const info = document.getElementById('manageDropsInfo');
        const list = document.getElementById('manageDropsList');
        if (!info || !list) return;

        if (!fishermanId) {
          info.innerText = 'Select a fisherman first.';
          list.innerHTML = '';
          return;
        }

        info.innerText = 'Loading...';
        list.innerHTML = '';

        google.script.run
          .withSuccessHandler(rows => {
            list.innerHTML = '';
            if (!rows || rows.length === 0) {
              info.innerText = 'No editable drop-offs found.';
              return;
            }
            info.innerText = '';

            const wrap = document.createElement('div');
            wrap.className = 'table-wrap';
            const table = document.createElement('table');
            table.innerHTML =
              '<thead>' +
              '<tr>' +
              '<th>Drop ID</th>' +
              '<th>Date</th>' +
              '<th>Weight (kg)</th>' +
              '<th>Purity</th>' +
              '<th>Inspector</th>' +
              '<th>Notes</th>' +
              '<th class="actions">Actions</th>' +
              '</tr>' +
              '</thead>' +
              '<tbody></tbody>';

            const tbody = table.querySelector('tbody');

            function mkTd(text, className) {
              const td = document.createElement('td');
              if (className) td.className = className;
              td.textContent = text || '';
              return td;
            }

            function refreshRowFromData(tr, d) {
              const cells = tr.querySelectorAll('td');
              if (cells.length < 7) return;
              cells[0].textContent = (d.dropId || '');
              cells[1].textContent = (d.date || '');
              cells[2].textContent = formatKg(d.netWeightKg || 0);
              cells[3].textContent = (d.purity || '');
              cells[4].textContent = (d.inspector || '');
              cells[5].textContent = (d.notes || '');
            }

            rows.forEach(d => {
              const tr = document.createElement('tr');
              tr.appendChild(mkTd(d.dropId || ''));
              tr.appendChild(mkTd(d.date || '', 'cell-muted'));
              tr.appendChild(mkTd(formatKg(d.netWeightKg || 0)));
              tr.appendChild(mkTd(d.purity || ''));
              tr.appendChild(mkTd(d.inspector || ''));
              tr.appendChild(mkTd(d.notes || ''));

              const tdActions = document.createElement('td');
              tdActions.className = 'actions';
              const btnEdit = document.createElement('button');
              btnEdit.className = 'secondary action-btn';
              btnEdit.textContent = 'Edit';
              const btnDelete = document.createElement('button');
              btnDelete.className = 'danger action-btn';
              btnDelete.style.marginLeft = '6px';
              btnDelete.textContent = 'Delete';
              const statusEl = document.createElement('div');
              statusEl.className = 'muted small';
              statusEl.style.marginTop = '6px';
              tdActions.appendChild(btnEdit);
              tdActions.appendChild(btnDelete);
              tdActions.appendChild(statusEl);
              tr.appendChild(tdActions);

              let isEditing = false;
              let original = null;

              function enterEdit() {
                if (isEditing) return;
                isEditing = true;
                statusEl.textContent = '';
                btnEdit.textContent = 'Cancel';

                original = {
                  netWeightKg: d.netWeightKg,
                  purity: d.purity,
                  inspector: d.inspector,
                  notes: d.notes
                };

                const weightTd = tr.children[2];
                const purityTd = tr.children[3];
                const inspectorTd = tr.children[4];
                const notesTd = tr.children[5];

                weightTd.innerHTML = '';
                purityTd.innerHTML = '';
                inspectorTd.innerHTML = '';
                notesTd.innerHTML = '';

                const w = document.createElement('input');
                w.className = 'inline-input';
                w.inputMode = 'numeric';
                w.pattern = '[0-9]*';
                w.value = String(Math.round((parseFloat(d.netWeightKg) || 0))).replace(/\D+/g, '');
                w.addEventListener('input', () => {
                  const v = (w.value || '').toString();
                  const cleaned = v.replace(/\D+/g, '');
                  if (v !== cleaned) w.value = cleaned;
                });

                const p = document.createElement('select');
                p.className = 'inline-input';
                ['Clean', 'Partial', 'Unclean'].forEach(optVal => {
                  const opt = document.createElement('option');
                  opt.value = optVal;
                  opt.textContent = optVal;
                  p.appendChild(opt);
                });
                p.value = (d.purity || 'Clean');

                const i = document.createElement('input');
                i.className = 'inline-input';
                i.value = (d.inspector || '').toString();

                const n = document.createElement('input');
                n.className = 'inline-input';
                n.value = (d.notes || '').toString();

                weightTd.appendChild(w);
                purityTd.appendChild(p);
                inspectorTd.appendChild(i);
                notesTd.appendChild(n);

                const saveBtn = document.createElement('button');
                saveBtn.className = 'submit-btn action-btn';
                saveBtn.style.marginLeft = '6px';
                saveBtn.textContent = 'Save';
                tdActions.insertBefore(saveBtn, statusEl);

                saveBtn.onclick = () => {
                  saveBtn.disabled = true;
                  btnDelete.disabled = true;
                  statusEl.textContent = 'Saving…';

                  const payload = {
                    dropId: d.dropId,
                    netWeightKg: (w && w.value) ? w.value : '',
                    purity: (p && p.value) ? p.value : 'Clean',
                    inspector: (i && i.value) ? i.value : '',
                    notes: (n && n.value) ? n.value : ''
                  };

                  google.script.run
                    .withSuccessHandler(() => {
                      // local update for immediate UI, server will fully reallocate anyway
                      d.netWeightKg = parseFloat(payload.netWeightKg) || d.netWeightKg;
                      d.purity = payload.purity;
                      d.inspector = payload.inspector;
                      d.notes = payload.notes;
                      statusEl.textContent = 'Saved.';
                      exitEdit(true);
                      refreshAfterDropMutation();
                    })
                    .withFailureHandler(err => {
                      saveBtn.disabled = false;
                      btnDelete.disabled = false;
                      statusEl.textContent = 'Error: ' + (err && err.message ? err.message : err);
                    })
                    .updateDropoffById(payload);
                };

                tr._saveBtn = saveBtn;
              }

              function exitEdit(revert) {
                if (!isEditing) return;
                isEditing = false;
                btnEdit.textContent = 'Edit';
                btnDelete.disabled = false;
                if (tr._saveBtn) {
                  try { tr._saveBtn.remove(); } catch (e) { }
                  tr._saveBtn = null;
                }
                if (revert && original) {
                  d.netWeightKg = original.netWeightKg;
                  d.purity = original.purity;
                  d.inspector = original.inspector;
                  d.notes = original.notes;
                }
                refreshRowFromData(tr, d);
              }

              btnEdit.onclick = () => {
                if (isEditing) {
                  exitEdit(true);
                } else {
                  enterEdit();
                }
              };

              btnDelete.onclick = () => {
                if (!confirm('Delete drop-off ' + (d.dropId || '') + '? This will recalculate due/accumulating payments.')) return;
                btnDelete.disabled = true;
                btnEdit.disabled = true;
                statusEl.textContent = '';
                google.script.run
                  .withSuccessHandler(() => {
                    statusEl.textContent = 'Deleted.';
                    refreshAfterDropMutation();
                  })
                  .withFailureHandler(err => {
                    btnDelete.disabled = false;
                    btnEdit.disabled = false;
                    alert('Error: ' + (err.message || err));
                  })
                  .deleteDropoffById({ dropId: d.dropId });
              };

              tbody.appendChild(tr);
            });

            wrap.appendChild(table);
            list.appendChild(wrap);
          })
          .withFailureHandler(err => {
            info.innerText = '';
            list.innerHTML = '';
            alert('Error: ' + (err.message || err));
          })
          .getEditableDropoffsByFishermanId(fishermanId);
      }

      function refreshAfterDropMutation() {
        // Reevaluation happens server-side; refresh all dependent UI.
        loadPaymentExplorer();
        loadVolunteerContribution();
        try { selectFisherman(lastSelectedFisherman || { personId: selectedFishermanId, fullName: document.getElementById('dropFishermanName') ? document.getElementById('dropFishermanName').innerText : '' }); } catch (e) { }
        loadManageDropoffs();
      }

      function attachDropWeightDigitsOnly() {
        const el = document.getElementById('dropWeight');
        if (!el) return;
        el.addEventListener('input', () => {
          const v = (el.value || '').toString();
          const cleaned = v.replace(/\D+/g, '');
          if (v !== cleaned) el.value = cleaned;
        });
      }

      function openRegisterModal({ prefillName }) {
        if (modalCloseTimer) {
          clearTimeout(modalCloseTimer);
          modalCloseTimer = null;
        }
        document.getElementById('mRegName').value = (prefillName || '').toString();
        document.getElementById('mRegPhone').value = '';
        document.getElementById('mRegVillage').value = '';
        document.getElementById('mRegResult').innerText = '';
        const submit = document.getElementById('mRegSubmit');
        submit.disabled = false;
        submit.textContent = 'Create & Use';
        document.getElementById('modalBackdrop').style.display = 'flex';
      }

      function closeModal() {
        if (modalCloseTimer) {
          clearTimeout(modalCloseTimer);
          modalCloseTimer = null;
        }
        document.getElementById('modalBackdrop').style.display = 'none';
        document.getElementById('mRegResult').innerText = '';
      }

      function openPaymentModal(p) {
        pendingPaymentConfirm = p || null;
        document.getElementById('mPayResult').innerText = '';
        document.getElementById('mPayId').innerText = (p && p.paymentId) ? p.paymentId : '—';
        document.getElementById('mPayFisherman').innerText = (p && p.fishermanName) ? p.fishermanName : '(Unknown)';
        document.getElementById('mPayWeight').innerText = (p && typeof p.accumulatedKg !== 'undefined') ? (formatKg(p.accumulatedKg) + ' kg') : '—';
        const amountText = (p && p.payloadRM !== '' && p.payloadRM != null) ? (p.payloadRM + ' RM') : '—';
        document.getElementById('mPayAmount').innerText = amountText;

        const confirmBtn = document.getElementById('mPayConfirm');
        if (confirmBtn) {
          confirmBtn.disabled = false;
          confirmBtn.textContent = 'Confirm payment';
        }

        const cancelBtn = document.getElementById('mPayCancel');
        if (cancelBtn) {
          cancelBtn.style.display = '';
          cancelBtn.disabled = false;
        }
        document.getElementById('paymentModalBackdrop').style.display = 'flex';
      }

      function closePaymentModal() {
        pendingPaymentConfirm = null;
        document.getElementById('paymentModalBackdrop').style.display = 'none';
        document.getElementById('mPayResult').innerText = '';
      }

      function confirmPaymentFromModal() {
        if (!pendingPaymentConfirm || !pendingPaymentConfirm.paymentId) return alert('Payment ID missing');
        const confirmBtn = document.getElementById('mPayConfirm');
        if (confirmBtn) {
          confirmBtn.disabled = true;
          confirmBtn.textContent = 'Confirming…';
        }

        const cancelBtn = document.getElementById('mPayCancel');
        if (cancelBtn) cancelBtn.style.display = 'none';
        document.getElementById('mPayResult').innerText = '';

        google.script.run
          .withSuccessHandler(() => {
            document.getElementById('mPayResult').innerText = 'Paid.';
            closePaymentModal();
            loadPaymentExplorer();
          })
          .withFailureHandler(err => {
            if (confirmBtn) {
              confirmBtn.disabled = false;
              confirmBtn.textContent = 'Confirm payment';
            }
            if (cancelBtn) cancelBtn.style.display = '';
            document.getElementById('mPayResult').innerText = 'Error: ' + (err && err.message ? err.message : err);
          })
          .confirmPayment(pendingPaymentConfirm.paymentId);
      }

      function registerFromModal() {
        const fullName = titleCaseInput(document.getElementById('mRegName').value);
        const phone = normalizeSpaces(document.getElementById('mRegPhone').value);
        const village = titleCaseInput(document.getElementById('mRegVillage').value);
        if (!fullName) return alert('Name required');

        const submit = document.getElementById('mRegSubmit');
        submit.disabled = true;
        submit.textContent = 'Creating…';

        // Close the modal shortly after click (do not wait for success)
        if (modalCloseTimer) clearTimeout(modalCloseTimer);
        modalCloseTimer = setTimeout(() => {
          closeModal();
        }, 2000);

        onSuccessAsync(res => {
          // keep local typeahead list up to date + select the new fisherman
          try {
            const newF = {
              personId: (res.personId || '').toString(),
              fullName: (res.fullName || fullName || '').toString(),
              phone: (res.phone || phone || '').toString(),
              village: (res.village || village || '').toString(),
              registryDate: res.registryDate || ''
            };
            if (newF.personId) {
              const exists = fishermenCache.some(f => (f.personId + '') === (newF.personId + ''));
              if (!exists) fishermenCache.unshift(newF);
              fishermenLoaded = true;
            }

            // select the newly created fisherman
            selectFisherman(newF);
            const q = document.getElementById('searchQ');
            if (q) q.value = newF.fullName || '';
          } catch (e) { }

          // refresh full list used by typeahead
          refreshFishermenCacheSilently();

          loadPaymentExplorer();
        }).registerFisherman({ fullName, phone, village });
      }

      function loadFishermenCache() {
        fishermenLoaded = false;
        onSuccessAsync(list => {
          if (!Array.isArray(list)) {
            fishermenCache = [];
            fishermenLoaded = false;
            try { console.error('getFishermen unexpected payload:', list); } catch (e) { }
            return;
          }
          fishermenCache = list;
          fishermenLoaded = true;
        }).getFishermen();
      }

      function refreshFishermenCacheSilently() {
        onSuccessAsync(list => {
          if (!Array.isArray(list)) return;
          fishermenCache = list;
          fishermenLoaded = true;
        }).getFishermen();
      }

      function attachTypeaheadHandlers() {
        const input = document.getElementById('searchQ');
        if (!input) return;
        input.addEventListener('input', () => {
          const q = input.value;
          const list = filterFishermen(q, 50);
          renderTypeahead(list, q);
        });
        input.addEventListener('focus', () => {
          const q = input.value;
          const list = filterFishermen(q, 50);
          renderTypeahead(list, q);
        });
        input.addEventListener('blur', () => {
          if (typeaheadHideTimer) clearTimeout(typeaheadHideTimer);
          typeaheadHideTimer = setTimeout(() => hideTypeahead(), 120);
        });
      }

      function loadPaymentExplorer() {
        loadDuePayments();
        loadPaidPayments();
      }

      function loadDuePayments() {
        const info = document.getElementById('dueInfo');
        const list = document.getElementById('dueList');
        info.innerText = 'Loading...';
        list.innerHTML = '';

        onSuccessAsync(rows => {
          list.innerHTML = '';
          if (!rows || rows.length === 0) {
            info.innerText = 'No payments due.';
            return;
          }
          info.innerText = '';

          rows.forEach(p => {
            const d = document.createElement('div');
            d.className = 'list-item compact';
            d.style.cursor = 'default';

            const name = p.fishermanName ? escapeHtml(p.fishermanName) : '(Unknown)';
            const phone = p.fishermanPhone ? (' — ' + escapeHtml(p.fishermanPhone)) : '';
            const payloadRmText = (p.payloadRM !== '' && p.payloadRM != null) ? escapeHtml(p.payloadRM) : '';
            const payloadBlock = payloadRmText ? ('<div><b>' + payloadRmText + ' RM</b></div>') : '<div class="muted small">&nbsp;</div>';

            d.innerHTML =
              '<div class="flex">' +
              '<div><b>' + name + '</b><span class="muted">' + phone + '</span></div>' +
              '<div class="right" style="text-align:right">' +
              payloadBlock +
              '<div><b>' + formatKg(p.accumulatedKg || 0) + ' kg</b></div>' +
              '</div>' +
              '</div>' +
              '<div class="small muted">' +
              (p.fishermanVillage ? ('Village: ' + escapeHtml(p.fishermanVillage) + ' • ') : '') +
              'Payment: ' + escapeHtml(p.paymentId || '') +
              '</div>' +
              '<div class="flex" style="margin-top:6px">' +
              '<button class="danger" data-confirm-payment="' + escapeHtml(p.paymentId) + '">Confirm payment</button>' +
              '<div class="right muted small" data-confirm-result></div>' +
              '</div>';

            const confirmBtn = d.querySelector('button[data-confirm-payment]');
            const confirmResult = d.querySelector('[data-confirm-result]');
            confirmBtn.onclick = () => {
              // Require explicit confirmation in modal (restates key financial details)
              openPaymentModal(p);
            };

            list.appendChild(d);
          });
        }).getDuePayments();
      }

      function loadPaidPayments() {
        const info = document.getElementById('paidInfo');
        const list = document.getElementById('paidList');
        info.innerText = 'Loading...';
        list.innerHTML = '';

        onSuccessAsync(rows => {
          list.innerHTML = '';

          // Month label + next button state (similar to volunteer panel)
          try {
            const d = new Date(paidMonthCursor.getFullYear(), paidMonthCursor.getMonth(), 1);
            document.getElementById('paidMonthLabel').innerText = d.toLocaleString(undefined, { month: 'long', year: 'numeric' });
          } catch (e) {
            document.getElementById('paidMonthLabel').innerText = 'Selected month';
          }
          try {
            const cur = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            const isCurrentMonth = (paidMonthCursor.getFullYear() === cur.getFullYear() && paidMonthCursor.getMonth() === cur.getMonth());
            document.getElementById('paidNext').disabled = !!isCurrentMonth;
          } catch (e) { }

          if (!rows || rows.length === 0) {
            info.innerText = 'No paid payments yet.';
            return;
          }
          info.innerText = '';

          const cursorKey = monthKeyFromDate(paidMonthCursor);
          const monthRows = rows.filter(p => monthKeyFromDate(parseDMYDateTime(p.date)) === cursorKey);
          if (monthRows.length === 0) {
            info.innerText = 'No paid payments for this month.';
            return;
          }

          monthRows.forEach(p => {
            const d = document.createElement('div');
            d.className = 'list-item';
            d.style.cursor = 'default';

            const name = p.fishermanName ? escapeHtml(p.fishermanName) : '(Unknown)';
            const phone = p.fishermanPhone ? (' — ' + escapeHtml(p.fishermanPhone)) : '';
            const when = p.date ? escapeHtml(formatPaymentExplorerDateTime(p.date)) : '';

            const payloadRmText = (p.payloadRM !== '' && p.payloadRM != null) ? escapeHtml(p.payloadRM) : '';
            const payloadBlock = payloadRmText ? ('<div><b>' + payloadRmText + ' RM</b></div>') : '<div class="muted small">&nbsp;</div>';

            d.innerHTML =
              '<div class="flex">' +
              '<div><b>' + name + '</b><span class="muted">' + phone + '</span></div>' +
              '<div class="right" style="text-align:right">' +
              payloadBlock +
              '<div><b>' + formatKg(p.accumulatedKg || 0) + ' kg</b></div>' +
              '</div>' +
              '</div>' +
              '<div class="small muted">' + (when ? when : '') + '</div>' +
              '<div class="small muted">Payment: ' + escapeHtml(p.paymentId || '') + ' • Fisherman ID: ' + escapeHtml(p.fishermanId || '') + '</div>' +
              '<div class="flex" style="margin-top:8px">' +
              '<button class="disclosure-btn" data-audit-payment="' + escapeHtml(p.paymentId) + '">&gt; View drop-offs</button>' +
              '<div class="right muted small" data-audit-status></div>' +
              '</div>' +
              '<div class="small" data-audit-panel style="margin-top:8px;display:none"></div>';

            const btn = d.querySelector('button[data-audit-payment]');
            const statusEl = d.querySelector('[data-audit-status]');
            const panel = d.querySelector('[data-audit-panel]');

            btn.onclick = () => {
              const isVisible = panel.style.display !== 'none';
              if (isVisible) {
                panel.style.display = 'none';
                btn.textContent = '> View drop-offs';
                statusEl.innerText = '';
                return;
              }

              btn.disabled = true;
              const prev = btn.textContent;
              btn.textContent = 'Loading…';
              statusEl.innerText = '';

              google.script.run
                .withSuccessHandler(drops => {
                  btn.disabled = false;
                  btn.textContent = 'v Hide drop-offs';
                  panel.style.display = 'block';

                  if (!drops || drops.length === 0) {
                    panel.innerHTML = '<div class="muted">No drop-offs tagged with this payment.</div>';
                    return;
                  }

                  const lines = drops.map(x => {
                    const date = x.date ? escapeHtml(x.date) : '';
                    const w = formatKg(x.netWeightKg || 0) + ' kg';
                    const purity = x.purity ? escapeHtml(x.purity) : '';
                    const inspector = x.inspector ? escapeHtml(x.inspector) : '';
                    const notes = x.notes ? escapeHtml(x.notes) : '';
                    const parts = [];
                    if (date) parts.push(date);
                    parts.push(w);
                    if (purity) parts.push('Purity: ' + purity);
                    if (inspector) parts.push('Inspector: ' + inspector);
                    if (notes) parts.push('Notes: ' + notes);
                    const dropId = x.dropId ? escapeHtml(x.dropId) : '';
                    return '<div style="padding:8px;border:1px solid #e6e6e6;border-radius:8px;margin-top:6px;background:#fff">' +
                      '<div><b>' + dropId + '</b></div>' +
                      '<div class="small">' + parts.join(' • ') + '</div>' +
                      '</div>';
                  });
                  panel.innerHTML = lines.join('');
                })
                .withFailureHandler(err => {
                  btn.disabled = false;
                  btn.textContent = prev;
                  alert('Error: ' + (err.message || err));
                })
                .getDropoffsByPaymentId(p.paymentId);
            };

            list.appendChild(d);
          });
        }).getPaidPayments();
      }

      function paidPrevMonth() {
        paidMonthCursor = new Date(paidMonthCursor.getFullYear(), paidMonthCursor.getMonth() - 1, 1);
        loadPaidPayments();
      }

      function paidNextMonth() {
        paidMonthCursor = new Date(paidMonthCursor.getFullYear(), paidMonthCursor.getMonth() + 1, 1);
        loadPaidPayments();
      }

      function getSelectedDropPurity() {
        const el = document.querySelector('input[name="dropPurity"]:checked');
        return el ? el.value : 'Clean';
      }


      function logDrop() {
        const fishermanId = (selectedFishermanId || '').toString().trim();
        const weightStr = (document.getElementById('dropWeight').value || '').toString().replace(/\D+/g, '');
        const netWeight = parseInt(weightStr, 10);
        if (!fishermanId) return alert('Fisherman ID required');
        if (!netWeight || netWeight <= 0) return alert('Weight must be > 0');
        const purity = getSelectedDropPurity();
        const inspector = titleCaseInput((document.getElementById('dropInspector').value || '').toString());
        if (!inspector) return alert('Inspector is required');
        const notes = document.getElementById('dropNotes').value;

        const submitBtn = document.getElementById('dropSubmitBtn');
        const prevText = submitBtn ? submitBtn.textContent : '';
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = 'Submitting…';
        }

        google.script.run
          .withSuccessHandler(res => {
            const r = res.allocationResult || res;
            document.getElementById('dropWeight').value = ''; document.getElementById('dropNotes').value = '';
            loadPaymentExplorer();
            loadVolunteerContribution();
            // refresh accumulating display after allocation
            try { selectFisherman(lastSelectedFisherman || { personId: fishermanId, fullName: document.getElementById('dropFishermanName') ? document.getElementById('dropFishermanName').innerText : '' }); } catch (e) { }

            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = prevText || 'Submit';
            }
          })
          .withFailureHandler(err => {
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = prevText || 'Submit';
            }
            alert('Error: ' + (err.message || err));
          })
          .logDropAndProcess({ fishermanId, netWeight, purity, inspector, notes });
      }

      function clearDropForm() {
        selectedFishermanId = '';
        lastSelectedFisherman = null;

        const idText = document.getElementById('dropFishermanIdText');
        if (idText) idText.innerText = '—';
        const nameEl = document.getElementById('dropFishermanName');
        if (nameEl) nameEl.innerText = 'None selected';
        const accumulatingEl = document.getElementById('dropAccumulatingWeight');
        if (accumulatingEl) accumulatingEl.innerText = '—';

        try {
          const editId = document.getElementById('editFishermanId');
          if (editId) editId.innerText = '—';
          const editName = document.getElementById('editName');
          if (editName) editName.value = '';
          const editPhone = document.getElementById('editPhone');
          if (editPhone) editPhone.value = '';
          const editVillage = document.getElementById('editVillage');
          if (editVillage) editVillage.value = '';
          const editRes = document.getElementById('editResult');
          if (editRes) editRes.textContent = '';
        } catch (e) { }

        document.getElementById('dropWeight').value = '';
        document.getElementById('dropInspector').value = '';
        document.getElementById('dropNotes').value = '';

        const clean = document.querySelector('input[name="dropPurity"][value="Clean"]');
        if (clean) clean.checked = true;
        setAdmitVisible(false);

        try {
          document.getElementById('manageDropsInfo').innerText = '';
          document.getElementById('manageDropsList').innerHTML = '';
        } catch (e) { }
      }

      function loadVolunteerContribution() {
        const y = volMonthCursor.getFullYear();
        const m = volMonthCursor.getMonth() + 1;
        document.getElementById('volMonthLabel').innerText = 'Loading...';
        document.getElementById('volSummary').innerText = '';
        document.getElementById('volList').innerHTML = '';

        onSuccessAsync(res => {
          document.getElementById('volMonthLabel').innerText = res.monthLabel;
          document.getElementById('volSummary').innerText =
            'Total: ' + formatKg(res.totalKg || 0) + ' kg' +
            ' • RM ' + formatRM(res.totalPayoutRM || 0) +
            ' (Clean ' + formatKg(res.totalCleanKg || 0) + ', Partial ' + formatKg(res.totalPartialKg || 0) + ', Unclean ' + formatKg(res.totalUncleanKg || 0) + ')';

          const nextBtn = document.getElementById('volNext');
          nextBtn.disabled = !!res.isCurrentMonth;

          const list = document.getElementById('volList');
          if (!res.items || res.items.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'muted small';
            empty.innerText = 'No drop-offs logged for this month.';
            list.appendChild(empty);
            return;
          }

          res.items.forEach(it => {
            const row = document.createElement('div');
            row.className = 'list-item';
            row.style.cursor = 'default';
            row.innerHTML =
              '<div class="flex">' +
              '<div><b>' + escapeHtml(it.inspector) + '</b> <span class="muted">•</span> <span class="small">' + formatKg(it.totalKg || 0) + ' kg</span></div>' +
              '<div class="right"><b>RM ' + formatRM(it.payoutRM || 0) + '</b></div>' +
              '</div>' +
              '<div class="small muted">Clean ' + formatKg(it.cleanKg || 0) + ' • Partial ' + formatKg(it.partialKg || 0) + ' • Unclean ' + formatKg(it.uncleanKg || 0) + '</div>';
            list.appendChild(row);
          });
        }).getVolunteerContributionMonth({ year: y, month: m });
      }

      function volPrevMonth() {
        volMonthCursor = new Date(volMonthCursor.getFullYear(), volMonthCursor.getMonth() - 1, 1);
        loadVolunteerContribution();
      }

      function volNextMonth() {
        volMonthCursor = new Date(volMonthCursor.getFullYear(), volMonthCursor.getMonth() + 1, 1);
        loadVolunteerContribution();
      }

      // init
      loadActiveDeal();
      loadFishermenCache();
      attachTypeaheadHandlers();
      attachDropWeightDigitsOnly();
      attachRegisterPhoneDigitsOnly();
      attachEditPhoneDigitsOnly();
      loadVolunteerContribution();
      loadPaymentExplorer();
      setAdmitVisible(false);

      try {
        const registerLink = document.getElementById('registerLink');
        if (registerLink) registerLink.classList.remove('hidden');
      } catch (e) { }
      setAdmitTab('admit');
    </script>

    <div class="footer-divider"></div>

    <footer class="footer muted small">
      <div class="footer-inner">
        <span>
          Need guidance?
          <a href="<?= adiDocUrl ?>" target="_blank" rel="noopener noreferrer">Read the docs</a>.
        </span>
        <span class="footer-actions">
          <span class="footer-sep" aria-hidden="true">|</span>
          <a class="github-link" href="https://github.com/mingaworks/fishnet-recycle-system" target="_blank"
            rel="noopener noreferrer" aria-label="Source code on GitHub" title="Source code on GitHub">
            <svg class="github-icon" viewBox="0 0 16 16" aria-hidden="true">
              <path
                d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0 0 16 8c0-4.42-3.58-8-8-8Z">
              </path>
            </svg>
          </a>
        </span>
      </div>
    </footer>
  </div>
</body>

</html>